/*! banana-fusion - v1.6.0 - 2016-03-21
 * https://github.com/LucidWorks/banana/wiki
 * Copyright (c) 2016 Andrew Thanalertvisuti; Licensed Apache License */

define("panels/scatterplot/module",["angular","app","underscore","jquery","d3"],function(a,b,c,d,e){"use strict";var f=a.module("kibana.panels.scatterplot",[]);b.useModule(f),f.controller("scatterplot",["$scope","$timeout","timer","dashboard","querySrv","filterSrv",function(b,d,f,g,h,i){b.panelMeta={modals:[{description:"Inspect",icon:"icon-info-sign",partial:"app/partials/inspector.html",show:b.panel.spyable}],editorTabs:[{title:"Queries",src:"app/partials/querySelect.html"}],status:"Experimental",description:"This panel help user to plot scatter plot between two variables"};var j={queries:{mode:"all",ids:[],query:"*:*",custom:""},max_rows:1e3,field:"date",xAxis:"Date",yAxis:"Rates",fl:"open,high,low,close",rightAxis:"volume",spyable:!0,show_queries:!0,refresh:{enable:!1,interval:2}};c.defaults(b.panel,j),b.init=function(){b.panel.refresh.enable&&b.set_timer(b.panel.refresh.interval),b.$on("refresh",function(){b.get_data()}),b.get_data()},b.set_timer=function(a){b.panel.refresh.interval=a,c.isNumber(b.panel.refresh.interval)?(f.cancel(b.refresh_timer),b.realtime()):f.cancel(b.refresh_timer)},b.realtime=function(){b.panel.refresh.enable?(f.cancel(b.refresh_timer),b.refresh_timer=f.register(d(function(){b.realtime(),b.get_data()},1e3*b.panel.refresh.interval))):f.cancel(b.refresh_timer)},b.get_data=function(){b.panelMeta.loading=!0,delete b.panel.error;var a,d;b.sjs.client.server(g.current.solr.server+g.current.solr.core_name),b.panel.queries.ids=h.idsByMode(b.panel.queries);var f=b.sjs.BoolQuery();c.each(b.panel.queries.ids,function(a){f=f.should(h.getEjsObj(a))}),a=b.sjs.Request().indices(g.indices),a=a.query(b.sjs.FilteredQuery(f,i.getBoolFilter(i.ids))).size(b.panel.max_rows),b.populate_modal(a);var j="";i.getSolrFq()&&(j="&"+i.getSolrFq());var k="&wt=csv",l="&fl="+b.panel.xaxis+","+b.panel.yaxis+","+b.panel.field_type,m="&rows="+b.panel.max_rows;b.panel.queries.query=h.getORquery()+j+l+k+m,a=null!=b.panel.queries.custom?a.setQuery(b.panel.queries.query+b.panel.queries.custom):a.setQuery(b.panel.queries.query),d=a.doSearch(),d.then(function(a){b.data=e.csv.parse(a),0===b.data.length&&(b.panel.error=b.parse_error("There's no data to show")),b.render()}),b.panelMeta.loading=!1},b.set_refresh=function(a){b.refresh=a},b.close_edit=function(){b.panel.refresh.enable&&b.set_timer(b.panel.refresh.interval),b.refresh&&b.get_data(),b.refresh=!1,b.$emit("render")},b.render=function(){b.$emit("render")},b.populate_modal=function(c){b.inspector=a.toJson(JSON.parse(c.toString()),!0)},b.pad=function(a){return(10>a?"0":"")+a}}]),f.directive("scatterplot",function(){return{restrict:"E",link:function(b,c){function f(){c.html("");var a=c[0],f=c.parent().width(),g=parseInt(b.row.height),h=50,i={top:20,right:20,bottom:100,left:50},j=f-i.left-i.right;g=g-i.top-i.bottom;var k=e.scale.linear().range([0,j-2*h]),l=e.scale.linear().range([g,0]),m=e.scale.category10(),n=e.svg.axis().scale(k).orient("bottom"),o=e.svg.axis().scale(l).orient("left"),p=e.select(a).append("svg").attr("width",j+i.left+i.right).attr("height",g+i.top+i.bottom).attr("viewBox","0 0 "+f+" "+(g+i.top)).attr("preserveAspectRatio","xMidYMid").append("g").attr("transform","translate("+i.left+","+i.top+")"),q=d("<div>");if(b.data.forEach(function(a){a[b.panel.yaxis]=+a[b.panel.yaxis],a[b.panel.xaxis]=+a[b.panel.xaxis]}),k.domain(e.extent(b.data,function(a){return a[b.panel.xaxis]})).nice(),l.domain(e.extent(b.data,function(a){return a[b.panel.yaxis]})).nice(),p.append("g").attr("class","x axis").attr("transform","translate(0,"+g+")").call(n).append("text").attr("class","label").attr("transform","translate("+(j/2-i.left)+" ,30)").style("text-anchor","middle").text(b.panel.xaxis),p.append("g").attr("class","y axis").call(o).append("text").attr("class","label").attr("transform","rotate(-90)").attr("y",0-i.left).attr("x",0-(g-i.top-i.bottom)/2).attr("dy",".71em").style("text-anchor","end").text(b.panel.yaxis),p.selectAll(".dot").data(b.data).enter().append("circle").attr("class","dot").attr("r",3.5).attr("cx",function(a){return k(a[b.panel.xaxis])}).attr("cy",function(a){return l(a[b.panel.yaxis])}).style("fill",function(a){return m(a[b.panel.field_type])}).on("mouseover",function(a){var c=a[b.panel.field_type]?a[b.panel.field_type]:"";q.html('<i class="icon-circle" style="color:'+m(a[b.panel.field_type])+';"></i> '+c+" ("+a[b.panel.xaxis]+", "+a[b.panel.yaxis]+")<br>").place_tt(e.event.pageX,e.event.pageY)}).on("mouseout",function(){q.detach()}),b.panel.field_type){var r=p.selectAll(".legend").data(m.domain()).enter().append("g").attr("class","legend").attr("transform",function(a,b){return"translate(0,"+20*b+")"});r.append("text").attr("x",j-24).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(a){return a}),r.append("rect").attr("x",j-18).attr("width",18).attr("height",18).style("fill",m)}}b.$on("render",function(){f()}),a.element(window).bind("resize",function(){f()})}}})});